---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# rolap

<!-- badges: start -->
<!-- badges: end -->

The goal of rolap is to ...

## Installation

You can install the development version of rolap from [GitHub](https://github.com/) with:

``` r
# install.packages("rolap")
devtools::install_github("josesamos/rolap")
```

## Example

Original data as a starting point, stored in `ft`.

```{r setup, echo = FALSE}
library(rolap)
```

```{r, results = "asis", echo = FALSE}
pander::pandoc.table(ft, split.table = Inf)
```

This is a basic example which shows you how to solve a common problem:

```{r example}
library(rolap)

when <- dimension_schema(name = "When",
                         attributes = c("Year"))

where <- dimension_schema(name = "Where",
                          attributes = c("REGION",
                                         "State",
                                         "City"))

s1 <- star_schema() |>
  define_facts(name = "MRS Cause",
               measures = c("Pneumonia and Influenza Deaths",
                            "All Deaths")) |>
  define_dimension(when) |>
  define_dimension(where)

ft1 <- ft |>
  dplyr::mutate(`Pneumonia and Influenza Deaths` = as.integer(`Pneumonia and Influenza Deaths`)) |>
  dplyr::mutate(`All Deaths` = as.integer(`All Deaths`)) |>
  dplyr::filter(Year > "1962")

db1 <- star_database(s1, ft1) |>
  snake_case()
```

The tables of dimensions and facts of the obtained star database are shown below.

```{r, results = "asis", echo = FALSE}
pander::pandoc.table(db1$instance$dimensions$when$table, split.table = Inf)
pander::pandoc.table(db1$instance$dimensions$where$table, split.table = Inf)
pander::pandoc.table(db1$instance$facts$mrs_cause$table, split.table = Inf)
```

```{r example2}
ft2 <- ft |>
  dplyr::select(-`Pneumonia and Influenza Deaths`, -`All Deaths`) |>
  tidyr::gather("Age", "All Deaths", 7:11) |>
  dplyr::mutate(`All Deaths` = as.integer(`All Deaths`)) |>
  dplyr::mutate(Age = stringr::str_replace(Age, " \\(all cause deaths\\)", "")) |>
  dplyr::filter(Year < "1964") |>
  dplyr::filter(City != "Boston" & City != "Bridgeport") |>
  dplyr::filter(WEEK >= "8")
```


```{r, results = "asis", echo = FALSE}
pander::pandoc.table(ft2, split.table = Inf)
```

```{r example3}
s2 <- star_schema() |>
  define_facts(name = "MRS Age",
               measures = c("All Deaths")) |>
  define_dimension(when) |>
  define_dimension(where) |>
  define_dimension(name = "Who",
                         attributes = c("Age"))

db2 <- star_database(s2, ft2) |>
  snake_case()
```

The tables of dimensions and facts of the obtained star database are shown below.

```{r, results = "asis", echo = FALSE}
pander::pandoc.table(db2$instance$dimensions$when$table, split.table = Inf)
pander::pandoc.table(db2$instance$dimensions$where$table, split.table = Inf)
pander::pandoc.table(db2$instance$dimensions$who$table, split.table = Inf)
pander::pandoc.table(db2$instance$facts$mrs_age$table, split.table = Inf)
```

```{r example4}
ct <- constellation("MRS", list(db1, db2))
```

```{r, results = "asis", echo = FALSE}
pander::pandoc.table(ct$dimensions$when$table, split.table = Inf)
pander::pandoc.table(ct$dimensions$where$table, split.table = Inf)
pander::pandoc.table(ct$dimensions$who$table, split.table = Inf)
pander::pandoc.table(ct$facts$mrs_cause$table, split.table = Inf)
pander::pandoc.table(ct$facts$mrs_age$table, split.table = Inf)
```

```{r example5}
ls <- db2 |>
  as_tibble_list()

lc <- ct |>
  as_tibble_list()
```
