---
title: "Integration of dimension instances"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Integration of dimension instances}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Introduction

It is generally recommended to perform data cleansing as close as possible to the original data sources. Sometimes, the need to perform data cleaning operations is detected when the multidimensional system is already implemented, either because it hasn't been detected in the data sources or because it comes from multiple data sources. For example, we can integrate several stars with common dimensions in a constellation and, when conforming the dimensions, we observe that there are instances that are actually the same and should be merged (they only differ in the form of abbreviation or in a misspelling). For these cases, the functions described in this vignette have been developed.

# Detection of repeated values in dimension instances

To show by example the available operations, we are going to use one of the multidimensional designs developed in the vignette titled *Star databases and RDBMS through the `dm` and `rolap` packages*, `vignette("rdbms-dm")`, which is available as a `star_database` object (`db_summary`). As shown below, we can get the names of the available dimensions.

```{r}
library(rolap)

class(db_summary)

db_tl <- db_summary |>
  as_tibble_list()

names <- names(db_tl)
for (i in seq_along(db_tl)){
  cat(sprintf("name: %s, %d rows\n", names[i], nrow(db_tl[[i]])))
}
```



```{r}
db_summary |>
  get_dimension_names()
```



Let's focus on the *what* dimension. 

```{r}
db_summary |> 
  get_attribute_names('what')
```

```{r}
db_summary |>
  get_similar_attribute_values('what')
```


```{r}
db_summary |>
  get_similar_attribute_values('who_segment')

db_summary |>
  get_similar_attribute_values('where_chain')
```




```{r, results = "asis"}
t <- db_summary |>
  get_unique_attribute_values('what', col_as_vector = "As a vector")

pander::pandoc.table(t, split.table = Inf)
```

```{r}

t <- db_summary |>
  get_unique_attribute_values('who_segment', col_as_vector = "As a vector")

pander::pandoc.table(t, split.table = Inf)

t <- db_summary |>
  get_unique_attribute_values('where_chain')

pander::pandoc.table(t, split.table = Inf)


db_summary |>
  get_similar_attribute_values('where_chain', attributes = 'segment')


```



```{r}
db_2 <- db_summary |>
  replace_attribute_values(
    name = 'what',
    attributes = 'product',
    old = c('Autokosmet.'),
    new = c('Autokozmetik')
  ) |>
  replace_attribute_values(
    name = 'what',
    attributes = 'product',
    old = c('Diesel aditiv'),
    new = c('Diesel +')
  ) |>
  replace_attribute_values(
    name = 'what',
    attributes = 'product',
    old = c('Nafta Plus'),
    new = c('Nafta +')
  ) |>
  replace_attribute_values(
    name = 'what',
    attributes = 'product',
    old = c('Nat.Super', 'Natural Plus', 'Natural Spec'),
    new = c('Natural +')
  ) |>
  replace_attribute_values(
    name = 'what',
    attributes = 'product',
    old = c('Autoprísluš.', 'Dalnic.popl.', 'Knihy,nov.', 'LPG', 'Mytí vozidel',
            'Nemrz.kapal.', 'Obcerstvení', 'Oleje,tuky', 'Potraviny', 'Prev.náplne',
            'Provoz.nápl.', 'Umývanie voz', 'Zboží nesp.', 'Zpr.nakupu'),
    new = c('Other')
  ) |>
  group_dimension_instances(name = 'what')
```

```{r, results = "asis"}
t <- db_2 |>
  get_unique_attribute_values('what', col_as_vector = "As a vector")

pander::pandoc.table(t, split.table = Inf)
```


```{r}
db_tl <- db_2 |>
  as_tibble_list()

names <- names(db_tl)
for (i in seq_along(db_tl)){
  cat(sprintf("name: %s, %d rows\n", names[i], nrow(db_tl[[i]])))
}

sum(db_tl[['transaction_summary']]$transactions)
```


```{r, results = "asis"}
t <- db_2 |>
  get_unique_attribute_values('when', attributes = c('date'))

pander::pandoc.table(t, split.table = Inf)


t <- db_2 |>
  get_unique_attribute_values('when_paid', attributes = c('payment_date'))

pander::pandoc.table(t, split.table = Inf)


db_2 |>
  get_role_playing_dimension_names()
```


```{r, results = "asis"}
t <- db_2 |>
  get_unique_attribute_values('when', attributes = c('hour'), col_as_vector = "As a vector")

pander::pandoc.table(t, split.table = Inf)
```


```{r}
db_3 <- db_2 |>
  replace_attribute_values(
    name = 'when',
    attributes = 'hour',
    old = c('05', '06', '07', '08', '09', '10', '11'),
    new = c('Morning')
  ) |>
  replace_attribute_values(
    name = 'when',
    attributes = 'hour',
    old = c('12', '13', '14', '15', '16'),
    new = c('Afternoon')
  ) |>
  replace_attribute_values(
    name = 'when',
    attributes = 'hour',
    old = c('17', '18', '19', '20'),
    new = c('Evening')
  ) |>
  replace_attribute_values(
    name = 'when',
    attributes = 'hour',
    old = c('21', '22', '23', '00', '01', '02', '03', '04'),
    new = c('Night')
  ) |>
  group_dimension_instances(name = 'when')
```

```{r}
db_tl <- db_3 |>
  as_tibble_list()

names <- names(db_tl)
for (i in seq_along(db_tl)){
  cat(sprintf("name: %s, %d rows\n", names[i], nrow(db_tl[[i]])))
}

sum(db_tl[['transaction_summary']]$transactions)
```


```{r, results = "asis"}
t <- db_3 |>
  get_unique_attribute_values('when')

pander::pandoc.table(t, split.table = Inf)
```


## Constellation

```{r}
ct <- constellation("CSS", list(db_finest, db_3))

ct_dm_all <- ct |>
  as_dm_class(pk_facts = FALSE)

tables <- ct |>
  get_table_names()

# Degenerate dimension
tables <- setdiff(tables, 'transaction')

ct_dm <-
  ct_dm_all[tables]

ct_dm |> 
  dm::dm_draw(view_type = "all")
```


