<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="rolap">
<title>Incremental refresh of star databases â€¢ rolap</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Incremental refresh of star databases">
<meta property="og:description" content="rolap">
<meta property="og:image" content="https://josesamos.github.io/rolap/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">rolap</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">2.3.0.9000</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../articles/rolap.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/v05-flat-table-op.html">Obtaining and transforming flat tables</a>
    <a class="dropdown-item" href="../articles/v10-rpd.html">Definition of role-playing and role dimensions</a>
    <a class="dropdown-item" href="../articles/v20-rdbms-dm.html">Star databases and RDBMS through the dm and rolap packages</a>
    <a class="dropdown-item" href="../articles/v30-dim-instances.html">Integration of dimension instances</a>
    <a class="dropdown-item" href="../articles/v40-refresh.html">Incremental refresh of star databases</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/josesamos/rolap/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">



<script src="v40-refresh_files/htmlwidgets-1.6.2/htmlwidgets.js"></script><script src="v40-refresh_files/viz-1.8.2/viz.js"></script><link href="v40-refresh_files/DiagrammeR-styles-0.2/styles.css" rel="stylesheet">
<script src="v40-refresh_files/grViz-binding-1.0.10/grViz.js"></script><div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Incremental refresh of star databases</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/josesamos/rolap/blob/HEAD/vignettes/v40-refresh.Rmd" class="external-link"><code>vignettes/v40-refresh.Rmd</code></a></small>
      <div class="d-none name"><code>v40-refresh.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>Once we have star databases built with the data available at the
moment, periodically we may obtain additional data, with the same
structure as the initial data but from a later time or from another
place. Sometimes the new data also contains instances which are already
included in the star database to operate on them.</p>
<p>Suppose we need to jointly analyse all the data available at the
moment: We must include them in the star database. One possibility is to
integrate all available data into a flat table and build the star
database again. Another possibility is to use the <em>incremental
refresh</em> mechanism described in this document.</p>
<p>This document shows by means of an example the possibilities offered
by the package in this context. First, the starting data sets are
presented. The next section shows how to generate the refresh
structures. The following section shows how to perform the incremental
refresh. Finally, we present how to make changes to the transformation
functions and add these changes for future refresh operations. Finish
with the conclusions.</p>
</div>
<div class="section level2">
<h2 id="starting-data-sets">Starting data sets<a class="anchor" aria-label="anchor" href="#starting-data-sets"></a>
</h2>
<p>The starting data set is the content in the variable
<code>mrs_db</code>, obtained in the vignette titled <em>Obtaining and
transforming flat tables</em>,
<code><a href="../articles/v05-flat-table-op.html">vignette("v05-flat-table-op")</a></code>. It contains the
constellation, formed by two star databases. Next we get their
names.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://josesamos.github.io/rolap/">rolap</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">mrs_db</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="../reference/get_fact_names.html">get_fact_names</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "mrs_age"   "mrs_cause"</span></span></code></pre></div>
<p>The code to generate the constellation from the initial data is
available in the vignette. Below is a graphic representation of the
tables that make it up.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">db_dm</span> <span class="op">&lt;-</span> <span class="va">mrs_db</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/as_dm_class.html">as_dm_class</a></span><span class="op">(</span>pk_facts <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">db_dm</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">dm</span><span class="fu">::</span><span class="fu"><a href="https://dm.cynkra.com/reference/dm_draw.html" class="external-link">dm_draw</a></span><span class="op">(</span>rankdir <span class="op">=</span> <span class="st">"LR"</span>, view_type <span class="op">=</span> <span class="st">"all"</span><span class="op">)</span></span></code></pre></div>
<div class="grViz html-widget html-fill-item-overflow-hidden html-fill-item" id="htmlwidget-ae18096767b82a0dc27b" style="width:700px;height:432.632880098888px;"></div>
<script type="application/json" data-for="htmlwidget-ae18096767b82a0dc27b">{"x":{"diagram":"#data_model\ndigraph {\ngraph [rankdir=LR tooltip=\"Data Model\" ]\n\nnode [margin=0 fontcolor = \"#444444\" ]\n\nedge [color = \"#555555\", arrowsize = 1, ]\n\npack=true\npackmode= \"node\"\n\n  \"mrs_age\" [id = \"mrs_age\", label = <<TABLE ALIGN=\"LEFT\" BORDER=\"1\" CELLBORDER=\"0\" CELLSPACING=\"0\" COLOR=\"#00005CAA\">\n    <TR>\n      <TD COLSPAN=\"1\" BGCOLOR=\"#00008BFF\" BORDER=\"0\"><FONT COLOR=\"#FFFFFF\">mrs_age<\/FONT>\n<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#CCCCE7FF\" PORT=\"when_key\">when_key<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#CCCCE7FF\" PORT=\"where_key\">where_key<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#CCCCE7FF\" PORT=\"who_key\">who_key<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#CCCCE7FF\">all_deaths<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#CCCCE7FF\">nrow_agg<\/TD>\n    <\/TR>\n  <\/TABLE>>, shape = \"plaintext\"] \n\n  \"mrs_cause\" [id = \"mrs_cause\", label = <<TABLE ALIGN=\"LEFT\" BORDER=\"1\" CELLBORDER=\"0\" CELLSPACING=\"0\" COLOR=\"#00005CAA\">\n    <TR>\n      <TD COLSPAN=\"1\" BGCOLOR=\"#00008BFF\" BORDER=\"0\"><FONT COLOR=\"#FFFFFF\">mrs_cause<\/FONT>\n<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#CCCCE7FF\" PORT=\"when_key\">when_key<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#CCCCE7FF\" PORT=\"where_key\">where_key<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#CCCCE7FF\">pneumonia_and_influenza_deaths<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#CCCCE7FF\">all_deaths<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#CCCCE7FF\">nrow_agg<\/TD>\n    <\/TR>\n  <\/TABLE>>, shape = \"plaintext\"] \n\n  \"when\" [id = \"when\", label = <<TABLE ALIGN=\"LEFT\" BORDER=\"1\" CELLBORDER=\"0\" CELLSPACING=\"0\" COLOR=\"#004200AA\">\n    <TR>\n      <TD COLSPAN=\"1\" BGCOLOR=\"#006400FF\" BORDER=\"0\"><FONT COLOR=\"#FFFFFF\">when<\/FONT>\n<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#CCE0CCFF\" PORT=\"when_key\"><U>when_key<\/U><\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#CCE0CCFF\">year<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#CCE0CCFF\">week<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#CCE0CCFF\">week_ending_date<\/TD>\n    <\/TR>\n  <\/TABLE>>, shape = \"plaintext\"] \n\n  \"where\" [id = \"where\", label = <<TABLE ALIGN=\"LEFT\" BORDER=\"1\" CELLBORDER=\"0\" CELLSPACING=\"0\" COLOR=\"#004200AA\">\n    <TR>\n      <TD COLSPAN=\"1\" BGCOLOR=\"#006400FF\" BORDER=\"0\"><FONT COLOR=\"#FFFFFF\">where<\/FONT>\n<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#CCE0CCFF\" PORT=\"where_key\"><U>where_key<\/U><\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#CCE0CCFF\">region<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#CCE0CCFF\">state<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#CCE0CCFF\">city<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#CCE0CCFF\">city_state<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#CCE0CCFF\">status<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#CCE0CCFF\">pop<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#CCE0CCFF\">lat<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#CCE0CCFF\">long<\/TD>\n    <\/TR>\n  <\/TABLE>>, shape = \"plaintext\"] \n\n  \"who\" [id = \"who\", label = <<TABLE ALIGN=\"LEFT\" BORDER=\"1\" CELLBORDER=\"0\" CELLSPACING=\"0\" COLOR=\"#004200AA\">\n    <TR>\n      <TD COLSPAN=\"1\" BGCOLOR=\"#006400FF\" BORDER=\"0\"><FONT COLOR=\"#FFFFFF\">who<\/FONT>\n<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#CCE0CCFF\" PORT=\"who_key\"><U>who_key<\/U><\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#CCE0CCFF\">age<\/TD>\n    <\/TR>\n  <\/TABLE>>, shape = \"plaintext\"] \n\n\"mrs_cause\":\"when_key\"->\"when\":\"when_key\" [id=\"mrs_cause_1\"]\n\"mrs_age\":\"when_key\"->\"when\":\"when_key\" [id=\"mrs_age_1\"]\n\"mrs_cause\":\"where_key\"->\"where\":\"where_key\" [id=\"mrs_cause_2\"]\n\"mrs_age\":\"where_key\"->\"where\":\"where_key\" [id=\"mrs_age_2\"]\n\"mrs_age\":\"who_key\"->\"who\":\"who_key\" [id=\"mrs_age_3\"]\n}","config":{"engine":null,"options":null}},"evals":[],"jsHooks":[]}</script><p>From the original data source (the <a href="https://catalog.data.gov/dataset/deaths-in-122-u-s-cities-1962-2016-122-cities-mortality-reporting-system" class="external-link">Deaths
in 122 U.S. cities - 1962-2016. 122 Cities Mortality Reporting
System</a> dataset), suppose <strong>we obtain a set of data that we
want to integrate with the previous data to analyse them
together</strong>.</p>
<p>We have stored it in the package, in a file with the same format as
the original file which only contains a small portion of the original
data. We have made sure that there is data that was already included in
the data set considered to obtain the content of the <code>mrs_db</code>
constellation and also new data. It is accessed below.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">file</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span></span>
<span>    <span class="st">"extdata"</span>,</span>
<span>    <span class="st">"mrs_122_us_cities_1962_2016_new.csv"</span>,</span>
<span>    package <span class="op">=</span> <span class="st">"rolap"</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">mrs_ft_new</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/read_flat_table_file.html">read_flat_table_file</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">'mrs new'</span>, <span class="va">file</span><span class="op">)</span></span></code></pre></div>
<p>Using the <code><a href="../reference/read_flat_table_file.html">read_flat_table_file()</a></code> function we read a
table stored in a text file and create a <code>flat_table</code> object
with a name. Below are the first records of the table. We access the
table using the <code><a href="../reference/get_table.html">get_table()</a></code> function for the object of the
<code>flat_table</code> class.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ft</span> <span class="op">&lt;-</span> <span class="va">mrs_ft_new</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="../reference/get_table.html">get_table</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">pander</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pander/man/pandoc.table.return.html" class="external-link">pandoc.table</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">ft</span><span class="op">)</span>, split.table <span class="op">=</span> <span class="cn">Inf</span><span class="op">)</span></span></code></pre></div>
<table style="width:100%;" class="table">
<colgroup>
<col width="2%">
<col width="2%">
<col width="7%">
<col width="3%">
<col width="3%">
<col width="5%">
<col width="13%">
<col width="5%">
<col width="11%">
<col width="12%">
<col width="5%">
<col width="13%">
<col width="13%">
</colgroup>
<thead><tr class="header">
<th align="center">Year</th>
<th align="center">WEEK</th>
<th align="center">Week Ending Date</th>
<th align="center">REGION</th>
<th align="center">State</th>
<th align="center">City</th>
<th align="center">Pneumonia and Influenza Deaths</th>
<th align="center">All Deaths</th>
<th align="center">&lt;1 year (all cause deaths)</th>
<th align="center">1-24 years (all cause deaths)</th>
<th align="center">25-44 years</th>
<th align="center">45-64 years (all cause deaths)</th>
<th align="center">65+ years (all cause deaths)</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="center">1962</td>
<td align="center">48</td>
<td align="center">12/01/1962</td>
<td align="center">2</td>
<td align="center">NY</td>
<td align="center">Buffalo</td>
<td align="center">5</td>
<td align="center">148</td>
<td align="center">10</td>
<td align="center">1</td>
<td align="center">11</td>
<td align="center">31</td>
<td align="center">95</td>
</tr>
<tr class="even">
<td align="center">1963</td>
<td align="center">3</td>
<td align="center">01/19/1963</td>
<td align="center">4</td>
<td align="center">IA</td>
<td align="center">Des Moines</td>
<td align="center">2</td>
<td align="center">55</td>
<td align="center">1</td>
<td align="center">3</td>
<td align="center">6</td>
<td align="center">17</td>
<td align="center">28</td>
</tr>
<tr class="odd">
<td align="center">1963</td>
<td align="center">6</td>
<td align="center">02/09/1963</td>
<td align="center">8</td>
<td align="center">CO</td>
<td align="center">Pueblo</td>
<td align="center">0</td>
<td align="center">21</td>
<td align="center">0</td>
<td align="center">0</td>
<td align="center">1</td>
<td align="center">4</td>
<td align="center">16</td>
</tr>
<tr class="even">
<td align="center">1963</td>
<td align="center">7</td>
<td align="center">02/16/1963</td>
<td align="center">7</td>
<td align="center">TX</td>
<td align="center">El Paso</td>
<td align="center">0</td>
<td align="center">39</td>
<td align="center">10</td>
<td align="center">2</td>
<td align="center">3</td>
<td align="center">9</td>
<td align="center">15</td>
</tr>
<tr class="odd">
<td align="center">1963</td>
<td align="center">25</td>
<td align="center">06/22/1963</td>
<td align="center">1</td>
<td align="center">MA</td>
<td align="center">Springfield</td>
<td align="center">5</td>
<td align="center">35</td>
<td align="center">0</td>
<td align="center">0</td>
<td align="center">1</td>
<td align="center">9</td>
<td align="center">25</td>
</tr>
<tr class="even">
<td align="center">1964</td>
<td align="center">10</td>
<td align="center">03/07/1964</td>
<td align="center">1</td>
<td align="center">MA</td>
<td align="center">Cambridge</td>
<td align="center">3</td>
<td align="center">31</td>
<td align="center">0</td>
<td align="center">0</td>
<td align="center">3</td>
<td align="center">10</td>
<td align="center">18</td>
</tr>
</tbody>
</table>
</div>
<div class="section level2">
<h2 id="generation-of-star-database-refresh-structures">Generation of star database refresh structures<a class="anchor" aria-label="anchor" href="#generation-of-star-database-refresh-structures"></a>
</h2>
<p>From the table that we have read, with the information contained in
the constellation variable, we can automatically generate refresh
structures for the star databases that make up the constellation.</p>
<div class="section level3">
<h3 id="refresh-structures">Refresh structures<a class="anchor" aria-label="anchor" href="#refresh-structures"></a>
</h3>
<p>From the data read in the form of a <code>flat_table</code> object,
using the <code><a href="../reference/update_according_to.html">update_according_to()</a></code> function, we generate a
refresh structure of the star database of the <code>mrs_db</code>
constellation whose name is indicated.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mrs_db_age_refresh</span> <span class="op">&lt;-</span> <span class="va">mrs_ft_new</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/update_according_to.html">update_according_to</a></span><span class="op">(</span><span class="va">mrs_db</span>, star <span class="op">=</span> <span class="st">"mrs_age"</span><span class="op">)</span></span></code></pre></div>
<p>The modification structure contains a star database generated from
the read data. We can see its graphical representation below.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">db_dm</span> <span class="op">&lt;-</span> <span class="va">mrs_db_age_refresh</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/get_star_database.html">get_star_database</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/as_dm_class.html">as_dm_class</a></span><span class="op">(</span>pk_facts <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">db_dm</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">dm</span><span class="fu">::</span><span class="fu"><a href="https://dm.cynkra.com/reference/dm_draw.html" class="external-link">dm_draw</a></span><span class="op">(</span>rankdir <span class="op">=</span> <span class="st">"LR"</span>, view_type <span class="op">=</span> <span class="st">"all"</span><span class="op">)</span></span></code></pre></div>
<div class="grViz html-widget html-fill-item-overflow-hidden html-fill-item" id="htmlwidget-8991a4e7f7cc3c2b7bb1" style="width:700px;height:432.632880098888px;"></div>
<script type="application/json" data-for="htmlwidget-8991a4e7f7cc3c2b7bb1">{"x":{"diagram":"#data_model\ndigraph {\ngraph [rankdir=LR tooltip=\"Data Model\" ]\n\nnode [margin=0 fontcolor = \"#444444\" ]\n\nedge [color = \"#555555\", arrowsize = 1, ]\n\npack=true\npackmode= \"node\"\n\n  \"mrs_age\" [id = \"mrs_age\", label = <<TABLE ALIGN=\"LEFT\" BORDER=\"1\" CELLBORDER=\"0\" CELLSPACING=\"0\" COLOR=\"#00005CAA\">\n    <TR>\n      <TD COLSPAN=\"1\" BGCOLOR=\"#00008BFF\" BORDER=\"0\"><FONT COLOR=\"#FFFFFF\">mrs_age<\/FONT>\n<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#CCCCE7FF\" PORT=\"when_key\">when_key<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#CCCCE7FF\" PORT=\"where_key\">where_key<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#CCCCE7FF\" PORT=\"who_key\">who_key<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#CCCCE7FF\">all_deaths<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#CCCCE7FF\">nrow_agg<\/TD>\n    <\/TR>\n  <\/TABLE>>, shape = \"plaintext\"] \n\n  \"when\" [id = \"when\", label = <<TABLE ALIGN=\"LEFT\" BORDER=\"1\" CELLBORDER=\"0\" CELLSPACING=\"0\" COLOR=\"#004200AA\">\n    <TR>\n      <TD COLSPAN=\"1\" BGCOLOR=\"#006400FF\" BORDER=\"0\"><FONT COLOR=\"#FFFFFF\">when<\/FONT>\n<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#CCE0CCFF\" PORT=\"when_key\"><U>when_key<\/U><\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#CCE0CCFF\">year<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#CCE0CCFF\">week<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#CCE0CCFF\">week_ending_date<\/TD>\n    <\/TR>\n  <\/TABLE>>, shape = \"plaintext\"] \n\n  \"where\" [id = \"where\", label = <<TABLE ALIGN=\"LEFT\" BORDER=\"1\" CELLBORDER=\"0\" CELLSPACING=\"0\" COLOR=\"#004200AA\">\n    <TR>\n      <TD COLSPAN=\"1\" BGCOLOR=\"#006400FF\" BORDER=\"0\"><FONT COLOR=\"#FFFFFF\">where<\/FONT>\n<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#CCE0CCFF\" PORT=\"where_key\"><U>where_key<\/U><\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#CCE0CCFF\">region<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#CCE0CCFF\">state<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#CCE0CCFF\">city<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#CCE0CCFF\">city_state<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#CCE0CCFF\">status<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#CCE0CCFF\">pop<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#CCE0CCFF\">lat<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#CCE0CCFF\">long<\/TD>\n    <\/TR>\n  <\/TABLE>>, shape = \"plaintext\"] \n\n  \"who\" [id = \"who\", label = <<TABLE ALIGN=\"LEFT\" BORDER=\"1\" CELLBORDER=\"0\" CELLSPACING=\"0\" COLOR=\"#004200AA\">\n    <TR>\n      <TD COLSPAN=\"1\" BGCOLOR=\"#006400FF\" BORDER=\"0\"><FONT COLOR=\"#FFFFFF\">who<\/FONT>\n<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#CCE0CCFF\" PORT=\"who_key\"><U>who_key<\/U><\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#CCE0CCFF\">age<\/TD>\n    <\/TR>\n  <\/TABLE>>, shape = \"plaintext\"] \n\n\"mrs_age\":\"when_key\"->\"when\":\"when_key\" [id=\"mrs_age_1\"]\n\"mrs_age\":\"where_key\"->\"where\":\"where_key\" [id=\"mrs_age_2\"]\n\"mrs_age\":\"who_key\"->\"who\":\"who_key\" [id=\"mrs_age_3\"]\n}","config":{"engine":null,"options":null}},"evals":[],"jsHooks":[]}</script><p>In exactly the same way, we generate the refresh structure for the
other star database.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mrs_db_cause_refresh</span> <span class="op">&lt;-</span> <span class="va">mrs_ft_new</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/update_according_to.html">update_according_to</a></span><span class="op">(</span><span class="va">mrs_db</span>, star <span class="op">=</span> <span class="st">"mrs_cause"</span><span class="op">)</span></span></code></pre></div>
<p>Below is its graphical representation.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">db_dm</span> <span class="op">&lt;-</span> <span class="va">mrs_db_cause_refresh</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/get_star_database.html">get_star_database</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/as_dm_class.html">as_dm_class</a></span><span class="op">(</span>pk_facts <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">db_dm</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">dm</span><span class="fu">::</span><span class="fu"><a href="https://dm.cynkra.com/reference/dm_draw.html" class="external-link">dm_draw</a></span><span class="op">(</span>rankdir <span class="op">=</span> <span class="st">"LR"</span>, view_type <span class="op">=</span> <span class="st">"all"</span><span class="op">)</span></span></code></pre></div>
<div class="grViz html-widget html-fill-item-overflow-hidden html-fill-item" id="htmlwidget-b70cdf281469a6997fbb" style="width:700px;height:432.632880098888px;"></div>
<script type="application/json" data-for="htmlwidget-b70cdf281469a6997fbb">{"x":{"diagram":"#data_model\ndigraph {\ngraph [rankdir=LR tooltip=\"Data Model\" ]\n\nnode [margin=0 fontcolor = \"#444444\" ]\n\nedge [color = \"#555555\", arrowsize = 1, ]\n\npack=true\npackmode= \"node\"\n\n  \"mrs_cause\" [id = \"mrs_cause\", label = <<TABLE ALIGN=\"LEFT\" BORDER=\"1\" CELLBORDER=\"0\" CELLSPACING=\"0\" COLOR=\"#00005CAA\">\n    <TR>\n      <TD COLSPAN=\"1\" BGCOLOR=\"#00008BFF\" BORDER=\"0\"><FONT COLOR=\"#FFFFFF\">mrs_cause<\/FONT>\n<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#CCCCE7FF\" PORT=\"when_key\">when_key<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#CCCCE7FF\" PORT=\"where_key\">where_key<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#CCCCE7FF\">pneumonia_and_influenza_deaths<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#CCCCE7FF\">all_deaths<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#CCCCE7FF\">nrow_agg<\/TD>\n    <\/TR>\n  <\/TABLE>>, shape = \"plaintext\"] \n\n  \"when\" [id = \"when\", label = <<TABLE ALIGN=\"LEFT\" BORDER=\"1\" CELLBORDER=\"0\" CELLSPACING=\"0\" COLOR=\"#004200AA\">\n    <TR>\n      <TD COLSPAN=\"1\" BGCOLOR=\"#006400FF\" BORDER=\"0\"><FONT COLOR=\"#FFFFFF\">when<\/FONT>\n<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#CCE0CCFF\" PORT=\"when_key\"><U>when_key<\/U><\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#CCE0CCFF\">year<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#CCE0CCFF\">week<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#CCE0CCFF\">week_ending_date<\/TD>\n    <\/TR>\n  <\/TABLE>>, shape = \"plaintext\"] \n\n  \"where\" [id = \"where\", label = <<TABLE ALIGN=\"LEFT\" BORDER=\"1\" CELLBORDER=\"0\" CELLSPACING=\"0\" COLOR=\"#004200AA\">\n    <TR>\n      <TD COLSPAN=\"1\" BGCOLOR=\"#006400FF\" BORDER=\"0\"><FONT COLOR=\"#FFFFFF\">where<\/FONT>\n<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#CCE0CCFF\" PORT=\"where_key\"><U>where_key<\/U><\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#CCE0CCFF\">region<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#CCE0CCFF\">state<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#CCE0CCFF\">city<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#CCE0CCFF\">city_state<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#CCE0CCFF\">status<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#CCE0CCFF\">pop<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#CCE0CCFF\">lat<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#CCE0CCFF\">long<\/TD>\n    <\/TR>\n  <\/TABLE>>, shape = \"plaintext\"] \n\n\"mrs_cause\":\"when_key\"->\"when\":\"when_key\" [id=\"mrs_cause_1\"]\n\"mrs_cause\":\"where_key\"->\"where\":\"where_key\" [id=\"mrs_cause_2\"]\n}","config":{"engine":null,"options":null}},"evals":[],"jsHooks":[]}</script>
</div>
<div class="section level3">
<h3 id="transformation-code">Transformation code<a class="anchor" aria-label="anchor" href="#transformation-code"></a>
</h3>
<p>The transformation code to generate the variable <code>mrs_db</code>
can be obtained in the vignette titled <em>Obtaining and transforming
flat tables</em>, <code><a href="../articles/v05-flat-table-op.html">vignette("v05-flat-table-op")</a></code>.</p>
<p>It is also included in the refresh structure for each of the star
databases obtained. It can be obtained using the
<code><a href="../reference/get_transformation_code.html">get_transformation_code()</a></code> and
<code><a href="../reference/get_transformation_file.html">get_transformation_file()</a></code> functions, in the form of a
vector of strings and a file respectively.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mrs_db_age_refresh</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/get_transformation_code.html">get_transformation_code</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1] "transform_instance_table &lt;- function(instance_df, lookup_ft, definition_fun, star_sch) {"                                                                                                                                    </span></span>
<span><span class="co">#&gt;  [2] "  ft &lt;- "                                                                                                                                                                                                                    </span></span>
<span><span class="co">#&gt;  [3] "    flat_table("                                                                                                                                                                                                             </span></span>
<span><span class="co">#&gt;  [4] "      name = 'mrs',"                                                                                                                                                                                                         </span></span>
<span><span class="co">#&gt;  [5] "      instances = instance_df,"                                                                                                                                                                                              </span></span>
<span><span class="co">#&gt;  [6] "      unknown_value = 'Not available'"                                                                                                                                                                                       </span></span>
<span><span class="co">#&gt;  [7] "    ) |&gt;"                                                                                                                                                                                                                    </span></span>
<span><span class="co">#&gt;  [8] "    transform_to_measure("                                                                                                                                                                                                   </span></span>
<span><span class="co">#&gt;  [9] "      attributes = c('Pneumonia and Influenza Deaths', 'All Deaths', '&lt;1 year (all cause deaths)', '1-24 years (all cause deaths)', '25-44 years', '45-64 years (all cause deaths)', '65+ years (all cause deaths)'),"       </span></span>
<span><span class="co">#&gt; [10] "      k_sep = NULL,"                                                                                                                                                                                                         </span></span>
<span><span class="co">#&gt; [11] "      decimal_sep = NULL"                                                                                                                                                                                                    </span></span>
<span><span class="co">#&gt; [12] "    ) |&gt;"                                                                                                                                                                                                                    </span></span>
<span><span class="co">#&gt; [13] "    transform_attribute_format("                                                                                                                                                                                             </span></span>
<span><span class="co">#&gt; [14] "      attributes = 'WEEK',"                                                                                                                                                                                                  </span></span>
<span><span class="co">#&gt; [15] "      width = 2,"                                                                                                                                                                                                            </span></span>
<span><span class="co">#&gt; [16] "      decimal_places = 0,"                                                                                                                                                                                                   </span></span>
<span><span class="co">#&gt; [17] "      k_sep = ',',"                                                                                                                                                                                                          </span></span>
<span><span class="co">#&gt; [18] "      decimal_sep = '.'"                                                                                                                                                                                                     </span></span>
<span><span class="co">#&gt; [19] "    ) |&gt;"                                                                                                                                                                                                                    </span></span>
<span><span class="co">#&gt; [20] "    replace_empty_values("                                                                                                                                                                                                   </span></span>
<span><span class="co">#&gt; [21] "      attributes = c('Year', 'WEEK', 'Week Ending Date', 'REGION', 'State', 'City'),"                                                                                                                                        </span></span>
<span><span class="co">#&gt; [22] "      empty_values = NULL"                                                                                                                                                                                                   </span></span>
<span><span class="co">#&gt; [23] "    ) |&gt;"                                                                                                                                                                                                                    </span></span>
<span><span class="co">#&gt; [24] "    add_custom_column("                                                                                                                                                                                                      </span></span>
<span><span class="co">#&gt; [25] "      name = 'city_state',"                                                                                                                                                                                                  </span></span>
<span><span class="co">#&gt; [26] "      definition = definition_fun"                                                                                                                                                                                           </span></span>
<span><span class="co">#&gt; [27] "    ) |&gt;"                                                                                                                                                                                                                    </span></span>
<span><span class="co">#&gt; [28] "    replace_attribute_values("                                                                                                                                                                                               </span></span>
<span><span class="co">#&gt; [29] "      attributes = c('City', 'city_state'),"                                                                                                                                                                                 </span></span>
<span><span class="co">#&gt; [30] "      old = c('Wilimington', 'Wilimington DE'),"                                                                                                                                                                             </span></span>
<span><span class="co">#&gt; [31] "      new = c('Wilmington', 'Wilmington DE')"                                                                                                                                                                                </span></span>
<span><span class="co">#&gt; [32] "    ) |&gt;"                                                                                                                                                                                                                    </span></span>
<span><span class="co">#&gt; [33] "    join_lookup_table("                                                                                                                                                                                                      </span></span>
<span><span class="co">#&gt; [34] "      fk_attributes = 'city_state',"                                                                                                                                                                                         </span></span>
<span><span class="co">#&gt; [35] "      lookup = lookup_ft"                                                                                                                                                                                                    </span></span>
<span><span class="co">#&gt; [36] "    ) |&gt;"                                                                                                                                                                                                                    </span></span>
<span><span class="co">#&gt; [37] "    select_attributes("                                                                                                                                                                                                      </span></span>
<span><span class="co">#&gt; [38] "      attributes = c('Year', 'WEEK', 'Week Ending Date', 'REGION', 'State', 'City', 'city_state', 'status', 'pop', 'lat', 'long')"                                                                                           </span></span>
<span><span class="co">#&gt; [39] "    ) |&gt;"                                                                                                                                                                                                                    </span></span>
<span><span class="co">#&gt; [40] "    separate_measures("                                                                                                                                                                                                      </span></span>
<span><span class="co">#&gt; [41] "      measures = list(c('Pneumonia and Influenza Deaths', 'All Deaths'), c('&lt;1 year (all cause deaths)', '1-24 years (all cause deaths)', '25-44 years', '45-64 years (all cause deaths)', '65+ years (all cause deaths)')),"</span></span>
<span><span class="co">#&gt; [42] "      names = c('mrs_cause', 'mrs_age'),"                                                                                                                                                                                    </span></span>
<span><span class="co">#&gt; [43] "      na_rm = TRUE"                                                                                                                                                                                                          </span></span>
<span><span class="co">#&gt; [44] "    ) |&gt;"                                                                                                                                                                                                                    </span></span>
<span><span class="co">#&gt; [45] "    magrittr::extract2('mrs_age') |&gt;"                                                                                                                                                                                        </span></span>
<span><span class="co">#&gt; [46] "    transform_to_values("                                                                                                                                                                                                    </span></span>
<span><span class="co">#&gt; [47] "      attribute = 'age',"                                                                                                                                                                                                    </span></span>
<span><span class="co">#&gt; [48] "      measure = 'all_deaths',"                                                                                                                                                                                               </span></span>
<span><span class="co">#&gt; [49] "      id_reverse = NULL,"                                                                                                                                                                                                    </span></span>
<span><span class="co">#&gt; [50] "      na_rm = TRUE"                                                                                                                                                                                                          </span></span>
<span><span class="co">#&gt; [51] "    ) |&gt;"                                                                                                                                                                                                                    </span></span>
<span><span class="co">#&gt; [52] "    snake_case("                                                                                                                                                                                                             </span></span>
<span><span class="co">#&gt; [53] "    ) |&gt;"                                                                                                                                                                                                                    </span></span>
<span><span class="co">#&gt; [54] "    replace_string("                                                                                                                                                                                                         </span></span>
<span><span class="co">#&gt; [55] "      attributes = 'age',"                                                                                                                                                                                                   </span></span>
<span><span class="co">#&gt; [56] "      string = ' (all cause deaths)',"                                                                                                                                                                                       </span></span>
<span><span class="co">#&gt; [57] "      replacement = NULL"                                                                                                                                                                                                    </span></span>
<span><span class="co">#&gt; [58] "    ) |&gt;"                                                                                                                                                                                                                    </span></span>
<span><span class="co">#&gt; [59] "    as_star_database("                                                                                                                                                                                                       </span></span>
<span><span class="co">#&gt; [60] "      schema = star_sch"                                                                                                                                                                                                     </span></span>
<span><span class="co">#&gt; [61] "    )"                                                                                                                                                                                                                       </span></span>
<span><span class="co">#&gt; [62] ""                                                                                                                                                                                                                            </span></span>
<span><span class="co">#&gt; [63] "  ft"                                                                                                                                                                                                                        </span></span>
<span><span class="co">#&gt; [64] "}"                                                                                                                                                                                                                           </span></span>
<span><span class="co">#&gt; [65] ""                                                                                                                                                                                                                            </span></span>
<span><span class="co">#&gt; [66] "ft &lt;- transform_instance_table(instance_df, lookup_ft, definition_fun, star_sch)"</span></span></code></pre></div>
<p>If additional transformations are needed, it can be modified to our
convenience. In the same way we consult it for the other star database,
although we donâ€™t show the result here.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">code</span> <span class="op">&lt;-</span> <span class="va">mrs_db_cause_refresh</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/get_transformation_code.html">get_transformation_code</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>We can see that the selection of the star database is done using the
<code><a href="https://magrittr.tidyverse.org/reference/aliases.html" class="external-link">magrittr::extract2()</a></code> function, which was not used in the
original vignette to select the elements of a list. It has been included
here to preserve the pipe syntax throughout the transformation.</p>
<p>This code only needs to be used if we want to perform additional
transformations. If the previously defined transformations are
sufficient, they have already been automatically applied to the data in
order to integrate them.</p>
</div>
<div class="section level3">
<h3 id="instances-included-in-the-structure">Instances included in the structure<a class="anchor" aria-label="anchor" href="#instances-included-in-the-structure"></a>
</h3>
<p>Seeing the new instances that are going to be added to the dimensions
can help us determine whether or not we need to modify the
transformation code. We can do this using the
<code><a href="../reference/get_new_dimension_instances.html">get_new_dimension_instances()</a></code> function, as shown below.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mrs_db_age_refresh</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/get_new_dimension_instances.html">get_new_dimension_instances</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; $when</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 110 Ã— 3</span></span></span>
<span><span class="co">#&gt;    year  week  week_ending_date</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>           </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> 1962  <span style="color: #949494;">"</span>48<span style="color: #949494;">"</span>  12/01/1962      </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> 1963  <span style="color: #949494;">"</span> 3<span style="color: #949494;">"</span>  01/19/1963      </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> 1963  <span style="color: #949494;">"</span> 7<span style="color: #949494;">"</span>  02/16/1963      </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> 1964  <span style="color: #949494;">"</span>10<span style="color: #949494;">"</span>  03/07/1964      </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> 1964  <span style="color: #949494;">"</span>12<span style="color: #949494;">"</span>  03/21/1964      </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> 1964  <span style="color: #949494;">"</span>20<span style="color: #949494;">"</span>  05/16/1964      </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> 1966  <span style="color: #949494;">"</span>26<span style="color: #949494;">"</span>  07/02/1966      </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> 1966  <span style="color: #949494;">"</span>47<span style="color: #949494;">"</span>  11/26/1966      </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> 1967  <span style="color: #949494;">"</span>10<span style="color: #949494;">"</span>  03/11/1967      </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> 1967  <span style="color: #949494;">"</span>22<span style="color: #949494;">"</span>  06/03/1967      </span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># â„¹ 100 more rows</span></span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $where</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 2 Ã— 8</span></span></span>
<span><span class="co">#&gt;   region state city      city_state   status        pop         lat   long    </span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>         <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> 1      MA    Boston    Boston MA    state capital <span style="color: #949494;">"</span>  567,759<span style="color: #949494;">"</span> 42.3  <span style="color: #949494;">"</span> -71.0<span style="color: #949494;">"</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> 5      MD    Baltimore Baltimore MD non-capital   <span style="color: #949494;">"</span>  602,658<span style="color: #949494;">"</span> 39.3  <span style="color: #949494;">"</span> -76.6<span style="color: #949494;">"</span></span></span></code></pre></div>
<p>If necessary, starting from the code that we have obtained, we can
perform transformations on the starting <code>flat_table</code>
structure or on the <code>star_database</code> object obtained.</p>
<p>We can see that there are two new cities that were not included in
the <em>where</em> dimension of the initial star databases:
<em>Baltimore</em> and <em>Boston</em>.</p>
</div>
</div>
<div class="section level2">
<h2 id="incremental-refresh">Incremental refresh<a class="anchor" aria-label="anchor" href="#incremental-refresh"></a>
</h2>
<p>The most common thing is that refresh operations only include new
instances in fact tables, but it may be the case that repeated instances
appear: They may have different values in the measures, but the same
values in the dimension foreign keys.</p>
<div class="section level3">
<h3 id="existing-fact-instances">Existing fact instances<a class="anchor" aria-label="anchor" href="#existing-fact-instances"></a>
</h3>
<p>To perform the incremental refresh operation, we must determine what
happens to the fact table instances that were already included in the
original star database. We can query existing fact instances using the
<code><a href="../reference/get_existing_fact_instances.html">get_existing_fact_instances()</a></code> function, as can be seen
below for each of the star databases.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mrs_db_age_refresh</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/get_existing_fact_instances.html">get_existing_fact_instances</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 200 Ã— 14</span></span></span>
<span><span class="co">#&gt;    year  week  week_ending_date region state city  city_state status pop   lat  </span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>            <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> 1963  <span style="color: #949494;">"</span>25<span style="color: #949494;">"</span>  06/22/1963       1      MA    Spriâ€¦ Springfieâ€¦ non-câ€¦ <span style="color: #949494;">"</span>  1â€¦ 42.1 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> 1963  <span style="color: #949494;">"</span>25<span style="color: #949494;">"</span>  06/22/1963       1      MA    Spriâ€¦ Springfieâ€¦ non-câ€¦ <span style="color: #949494;">"</span>  1â€¦ 42.1 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> 1963  <span style="color: #949494;">"</span>25<span style="color: #949494;">"</span>  06/22/1963       1      MA    Spriâ€¦ Springfieâ€¦ non-câ€¦ <span style="color: #949494;">"</span>  1â€¦ 42.1 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> 1963  <span style="color: #949494;">"</span>25<span style="color: #949494;">"</span>  06/22/1963       1      MA    Spriâ€¦ Springfieâ€¦ non-câ€¦ <span style="color: #949494;">"</span>  1â€¦ 42.1 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> 1963  <span style="color: #949494;">"</span>25<span style="color: #949494;">"</span>  06/22/1963       1      MA    Spriâ€¦ Springfieâ€¦ non-câ€¦ <span style="color: #949494;">"</span>  1â€¦ 42.1 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> 1965  <span style="color: #949494;">"</span> 5<span style="color: #949494;">"</span>  02/06/1965       4      KS    Wichâ€¦ Wichita KS non-câ€¦ <span style="color: #949494;">"</span>  3â€¦ 37.7 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> 1965  <span style="color: #949494;">"</span> 5<span style="color: #949494;">"</span>  02/06/1965       4      KS    Wichâ€¦ Wichita KS non-câ€¦ <span style="color: #949494;">"</span>  3â€¦ 37.7 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> 1965  <span style="color: #949494;">"</span> 5<span style="color: #949494;">"</span>  02/06/1965       4      KS    Wichâ€¦ Wichita KS non-câ€¦ <span style="color: #949494;">"</span>  3â€¦ 37.7 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> 1965  <span style="color: #949494;">"</span> 5<span style="color: #949494;">"</span>  02/06/1965       4      KS    Wichâ€¦ Wichita KS non-câ€¦ <span style="color: #949494;">"</span>  3â€¦ 37.7 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> 1965  <span style="color: #949494;">"</span> 5<span style="color: #949494;">"</span>  02/06/1965       4      KS    Wichâ€¦ Wichita KS non-câ€¦ <span style="color: #949494;">"</span>  3â€¦ 37.7 </span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># â„¹ 190 more rows</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># â„¹ 4 more variables: long &lt;chr&gt;, age &lt;chr&gt;, all_deaths &lt;int&gt;, nrow_agg &lt;int&gt;</span></span></span>
<span></span>
<span><span class="va">mrs_db_cause_refresh</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/get_existing_fact_instances.html">get_existing_fact_instances</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 40 Ã— 14</span></span></span>
<span><span class="co">#&gt;    year  week  week_ending_date region state city  city_state status pop   lat  </span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>            <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> 1963  <span style="color: #949494;">"</span>25<span style="color: #949494;">"</span>  06/22/1963       1      MA    Spriâ€¦ Springfieâ€¦ non-câ€¦ <span style="color: #949494;">"</span>  1â€¦ 42.1 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> 1965  <span style="color: #949494;">"</span> 5<span style="color: #949494;">"</span>  02/06/1965       4      KS    Wichâ€¦ Wichita KS non-câ€¦ <span style="color: #949494;">"</span>  3â€¦ 37.7 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> 1966  <span style="color: #949494;">"</span>35<span style="color: #949494;">"</span>  09/03/1966       9      CA    Longâ€¦ Long Beacâ€¦ non-câ€¦ <span style="color: #949494;">"</span>  4â€¦ 33.8 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> 1966  <span style="color: #949494;">"</span>41<span style="color: #949494;">"</span>  10/15/1966       9      CA    San â€¦ San Jose â€¦ non-câ€¦ <span style="color: #949494;">"</span>  8â€¦ 37.3 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> 1968  <span style="color: #949494;">"</span>29<span style="color: #949494;">"</span>  07/20/1968       3      OH    Younâ€¦ Youngstowâ€¦ non-câ€¦ <span style="color: #949494;">"</span>   â€¦ 41.1 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> 1971  <span style="color: #949494;">"</span>28<span style="color: #949494;">"</span>  07/17/1971       3      IL    Chicâ€¦ Chicago IL non-câ€¦ <span style="color: #949494;">"</span>2,8â€¦ 41.8 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> 1973  <span style="color: #949494;">"</span> 6<span style="color: #949494;">"</span>  02/10/1973       2      NY    Syraâ€¦ Syracuse â€¦ non-câ€¦ <span style="color: #949494;">"</span>  1â€¦ 43.0 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> 1974  <span style="color: #949494;">"</span>49<span style="color: #949494;">"</span>  12/07/1974       5      FL    Tampa Tampa FL   non-câ€¦ <span style="color: #949494;">"</span>  3â€¦ 28.0 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> 1976  <span style="color: #949494;">"</span>48<span style="color: #949494;">"</span>  12/04/1976       9      CA    Fresâ€¦ Fresno CA  non-câ€¦ <span style="color: #949494;">"</span>  4â€¦ 36.8 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> 1977  <span style="color: #949494;">"</span>21<span style="color: #949494;">"</span>  05/28/1977       6      TN    Mempâ€¦ Memphis TN non-câ€¦ <span style="color: #949494;">"</span>  6â€¦ 35.1 </span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># â„¹ 30 more rows</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># â„¹ 4 more variables: long &lt;chr&gt;, pneumonia_and_influenza_deaths &lt;int&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   all_deaths &lt;int&gt;, nrow_agg &lt;int&gt;</span></span></span></code></pre></div>
<p>In each case it may be interesting to perform a different operation
on these previously existing instances. By default, what is done is to
ignore them but we can indicate that they are grouped, replaced or
deleted, using the <code>existing_instances</code> parameter.</p>
</div>
<div class="section level3">
<h3 id="incremental-refresh-operation">Incremental refresh operation<a class="anchor" aria-label="anchor" href="#incremental-refresh-operation"></a>
</h3>
<p>To better appreciate the update made, we are going to perform the
same query before and after the incremental refresh operation: We obtain
the design tables, along with the number of instances of each one. For
the <em>where</em> dimension table, we get the names of the first cities
to check that <em>Baltimore</em> and <em>Boston</em> were not
included.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">l_db</span> <span class="op">&lt;-</span> <span class="va">mrs_db</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/as_tibble_list.html">as_tibble_list</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">names</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">l_db</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">l_db</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"name: %s, %d rows\n"</span>, <span class="va">names</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">l_db</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt; name: when, 1966 rows</span></span>
<span><span class="co">#&gt; name: where, 120 rows</span></span>
<span><span class="co">#&gt; name: who, 5 rows</span></span>
<span><span class="co">#&gt; name: mrs_cause, 3342 rows</span></span>
<span><span class="co">#&gt; name: mrs_age, 16565 rows</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="va">l_db</span><span class="op">[[</span><span class="st">'where'</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">city</span><span class="op">)</span>, <span class="fl">15</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1] "Akron"       "Albany"      "Albuquerque" "Allentown"   "Atlanta"    </span></span>
<span><span class="co">#&gt;  [6] "Austin"      "Baton Rouge" "Berkeley"    "Birmingham"  "Boise"      </span></span>
<span><span class="co">#&gt; [11] "Bridgeport"  "Buffalo"     "Cambridge"   "Camden"      "Canton"</span></span></code></pre></div>
<p>Next, we perform the incremental refresh for each of the star
databases in the original constellation. For one of the star databases,
through the <code>existing_instances</code> parameter, it has been
indicated that the instances of previously existing facts are grouped
with the new ones. For the other design, the default option is
considered: Ignore fact table previously existing instances.</p>
<p>We will make a copy of the constellation to perform an operation
later.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mrs_db_seg</span> <span class="op">&lt;-</span> <span class="va">mrs_db</span></span>
<span></span>
<span><span class="va">mrs_db</span> <span class="op">&lt;-</span> <span class="va">mrs_db</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/incremental_refresh.html">incremental_refresh</a></span><span class="op">(</span><span class="va">mrs_db_age_refresh</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/incremental_refresh.html">incremental_refresh</a></span><span class="op">(</span><span class="va">mrs_db_cause_refresh</span>, existing_instances <span class="op">=</span> <span class="st">"group"</span><span class="op">)</span></span></code></pre></div>
<p>Finally, we consult the same data as before again.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">l_db</span> <span class="op">&lt;-</span> <span class="va">mrs_db</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/as_tibble_list.html">as_tibble_list</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">names</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">l_db</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">l_db</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"name: %s, %d rows\n"</span>, <span class="va">names</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">l_db</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt; name: when, 2076 rows</span></span>
<span><span class="co">#&gt; name: where, 122 rows</span></span>
<span><span class="co">#&gt; name: who, 5 rows</span></span>
<span><span class="co">#&gt; name: mrs_cause, 3677 rows</span></span>
<span><span class="co">#&gt; name: mrs_age, 18228 rows</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="va">l_db</span><span class="op">[[</span><span class="st">'where'</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">city</span><span class="op">)</span>, <span class="fl">15</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1] "Akron"       "Albany"      "Albuquerque" "Allentown"   "Atlanta"    </span></span>
<span><span class="co">#&gt;  [6] "Austin"      "Baltimore"   "Baton Rouge" "Berkeley"    "Birmingham" </span></span>
<span><span class="co">#&gt; [11] "Boise"       "Boston"      "Bridgeport"  "Buffalo"     "Cambridge"</span></span></code></pre></div>
<p>We observe how the number of instances has increased in the facts and
in the dimensions and the <em>where</em> dimension already contains the
names of the cities that appeared as new in the update operation.</p>
</div>
</div>
<div class="section level2">
<h2 id="changes-in-transformation-operations">Changes in transformation operations<a class="anchor" aria-label="anchor" href="#changes-in-transformation-operations"></a>
</h2>
<p>In this case no problem has been detected in the new dimension data.
But letâ€™s assume that we wanted to make some change to the modify
operations before doing the update to show how it would be done.</p>
<div class="section level3">
<h3 id="new-transformation-function">New transformation function<a class="anchor" aria-label="anchor" href="#new-transformation-function"></a>
</h3>
<p>First of all, we obtain the transformation function. In this case we
have stored it in a temporary file using the
<code><a href="../reference/get_transformation_file.html">get_transformation_file()</a></code> function and we have copied it
here.</p>
<p>Starting from the <code>tibble</code> of the initial
<code>flat_table</code>, the <code>star_schema</code> to define the
<code>star_database</code>, the lookup tables and field definition
functions that we have used, we can reproduce all the transformations
and adapt them to the new situations that hypothetically have
arisen.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">transform_instance_table</span> <span class="op">&lt;-</span></span>
<span>  <span class="kw">function</span><span class="op">(</span><span class="va">instance_df</span>,</span>
<span>           <span class="va">lookup_ft</span>,</span>
<span>           <span class="va">definition_fun</span>,</span>
<span>           <span class="va">star_sch</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">ft</span> <span class="op">&lt;-</span></span>
<span>      <span class="fu"><a href="../reference/flat_table.html">flat_table</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">'mrs'</span>,</span>
<span>                 instances <span class="op">=</span> <span class="va">instance_df</span>,</span>
<span>                 unknown_value <span class="op">=</span> <span class="st">'Not available'</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu"><a href="../reference/transform_to_measure.html">transform_to_measure</a></span><span class="op">(</span></span>
<span>        attributes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>          <span class="st">'Pneumonia and Influenza Deaths'</span>,</span>
<span>          <span class="st">'All Deaths'</span>,</span>
<span>          <span class="st">'&lt;1 year (all cause deaths)'</span>,</span>
<span>          <span class="st">'1-24 years (all cause deaths)'</span>,</span>
<span>          <span class="st">'25-44 years'</span>,</span>
<span>          <span class="st">'45-64 years (all cause deaths)'</span>,</span>
<span>          <span class="st">'65+ years (all cause deaths)'</span></span>
<span>        <span class="op">)</span>,</span>
<span>        k_sep <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>        decimal_sep <span class="op">=</span> <span class="cn">NULL</span></span>
<span>      <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu"><a href="../reference/transform_attribute_format.html">transform_attribute_format</a></span><span class="op">(</span></span>
<span>        attributes <span class="op">=</span> <span class="st">'WEEK'</span>,</span>
<span>        width <span class="op">=</span> <span class="fl">2</span>,</span>
<span>        decimal_places <span class="op">=</span> <span class="fl">0</span>,</span>
<span>        k_sep <span class="op">=</span> <span class="st">','</span>,</span>
<span>        decimal_sep <span class="op">=</span> <span class="st">'.'</span></span>
<span>      <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu"><a href="../reference/replace_empty_values.html">replace_empty_values</a></span><span class="op">(</span></span>
<span>        attributes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Year'</span>, <span class="st">'WEEK'</span>, <span class="st">'Week Ending Date'</span>, <span class="st">'REGION'</span>, <span class="st">'State'</span>, <span class="st">'City'</span><span class="op">)</span>,</span>
<span>        empty_values <span class="op">=</span> <span class="cn">NULL</span></span>
<span>      <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu"><a href="../reference/add_custom_column.html">add_custom_column</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">'city_state'</span>,</span>
<span>                        definition <span class="op">=</span> <span class="va">definition_fun</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu"><a href="../reference/replace_attribute_values.html">replace_attribute_values</a></span><span class="op">(</span></span>
<span>        attributes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'City'</span>, <span class="st">'city_state'</span><span class="op">)</span>,</span>
<span>        old <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Wilimington'</span>, <span class="st">'Wilimington DE'</span><span class="op">)</span>,</span>
<span>        new <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Wilmington'</span>, <span class="st">'Wilmington DE'</span><span class="op">)</span></span>
<span>      <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu"><a href="../reference/join_lookup_table.html">join_lookup_table</a></span><span class="op">(</span>fk_attributes <span class="op">=</span> <span class="st">'city_state'</span>,</span>
<span>                        lookup <span class="op">=</span> <span class="va">lookup_ft</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu"><a href="../reference/select_attributes.html">select_attributes</a></span><span class="op">(</span></span>
<span>        attributes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>          <span class="st">'Year'</span>,</span>
<span>          <span class="st">'WEEK'</span>,</span>
<span>          <span class="st">'Week Ending Date'</span>,</span>
<span>          <span class="st">'REGION'</span>,</span>
<span>          <span class="st">'State'</span>,</span>
<span>          <span class="st">'City'</span>,</span>
<span>          <span class="st">'city_state'</span>,</span>
<span>          <span class="st">'status'</span>,</span>
<span>          <span class="st">'pop'</span>,</span>
<span>          <span class="st">'lat'</span>,</span>
<span>          <span class="st">'long'</span></span>
<span>        <span class="op">)</span></span>
<span>      <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu"><a href="../reference/separate_measures.html">separate_measures</a></span><span class="op">(</span></span>
<span>        measures <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>          <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Pneumonia and Influenza Deaths'</span>, <span class="st">'All Deaths'</span><span class="op">)</span>,</span>
<span>          <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>            <span class="st">'&lt;1 year (all cause deaths)'</span>,</span>
<span>            <span class="st">'1-24 years (all cause deaths)'</span>,</span>
<span>            <span class="st">'25-44 years'</span>,</span>
<span>            <span class="st">'45-64 years (all cause deaths)'</span>,</span>
<span>            <span class="st">'65+ years (all cause deaths)'</span></span>
<span>          <span class="op">)</span></span>
<span>        <span class="op">)</span>,</span>
<span>        names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'mrs_cause'</span>, <span class="st">'mrs_age'</span><span class="op">)</span>,</span>
<span>        na_rm <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>      <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu">magrittr</span><span class="fu">::</span><span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html" class="external-link">extract2</a></span><span class="op">(</span><span class="st">'mrs_cause'</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu"><a href="../reference/snake_case.html">snake_case</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu"><a href="../reference/as_star_database.html">as_star_database</a></span><span class="op">(</span>schema <span class="op">=</span> <span class="va">star_sch</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="va">ft</span></span>
<span>  <span class="op">}</span></span></code></pre></div>
<p>We can get these parameters from the initial definition (in the
vignette titled <em>Obtaining and transforming flat tables</em>,
<code><a href="../articles/v05-flat-table-op.html">vignette("v05-flat-table-op")</a></code>) or by consulting the refresh
structure with the functions available for this purpose.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">instance_df</span> <span class="op">&lt;-</span> <span class="va">mrs_ft_new</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="../reference/get_table.html">get_table</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  </span>
<span><span class="va">lookup_list</span> <span class="op">&lt;-</span> <span class="va">mrs_db_cause_refresh</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="../reference/get_lookup_tables.html">get_lookup_tables</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">star_sch</span> <span class="op">&lt;-</span> <span class="va">mrs_db_cause_refresh</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="../reference/get_star_schema.html">get_star_schema</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># function to define a derived column</span></span>
<span><span class="va">city_state</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">table</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">table</span><span class="op">$</span><span class="va">City</span>, <span class="st">' '</span>, <span class="va">table</span><span class="op">$</span><span class="va">State</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">mrs_db_cause_transf</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">transform_instance_table</span><span class="op">(</span></span>
<span>    instance_df <span class="op">=</span> <span class="va">instance_df</span>,</span>
<span>    lookup_ft <span class="op">=</span> <span class="va">lookup_list</span><span class="op">[[</span><span class="st">'us_cities'</span><span class="op">]</span><span class="op">]</span>,</span>
<span>    definition_fun <span class="op">=</span> <span class="va">city_state</span>,</span>
<span>    star_sch <span class="op">=</span> <span class="va">star_sch</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>We perform the same operation for the other star database.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">transform_instance_table_2</span> <span class="op">&lt;-</span></span>
<span>  <span class="kw">function</span><span class="op">(</span><span class="va">instance_df</span>,</span>
<span>           <span class="va">lookup_ft</span>,</span>
<span>           <span class="va">definition_fun</span>,</span>
<span>           <span class="va">star_sch</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">ft</span> <span class="op">&lt;-</span></span>
<span>      <span class="fu"><a href="../reference/flat_table.html">flat_table</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">'mrs'</span>,</span>
<span>                 instances <span class="op">=</span> <span class="va">instance_df</span>,</span>
<span>                 unknown_value <span class="op">=</span> <span class="st">'Not available'</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu"><a href="../reference/transform_to_measure.html">transform_to_measure</a></span><span class="op">(</span></span>
<span>        attributes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>          <span class="st">'Pneumonia and Influenza Deaths'</span>,</span>
<span>          <span class="st">'All Deaths'</span>,</span>
<span>          <span class="st">'&lt;1 year (all cause deaths)'</span>,</span>
<span>          <span class="st">'1-24 years (all cause deaths)'</span>,</span>
<span>          <span class="st">'25-44 years'</span>,</span>
<span>          <span class="st">'45-64 years (all cause deaths)'</span>,</span>
<span>          <span class="st">'65+ years (all cause deaths)'</span></span>
<span>        <span class="op">)</span>,</span>
<span>        k_sep <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>        decimal_sep <span class="op">=</span> <span class="cn">NULL</span></span>
<span>      <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu"><a href="../reference/transform_attribute_format.html">transform_attribute_format</a></span><span class="op">(</span></span>
<span>        attributes <span class="op">=</span> <span class="st">'WEEK'</span>,</span>
<span>        width <span class="op">=</span> <span class="fl">2</span>,</span>
<span>        decimal_places <span class="op">=</span> <span class="fl">0</span>,</span>
<span>        k_sep <span class="op">=</span> <span class="st">','</span>,</span>
<span>        decimal_sep <span class="op">=</span> <span class="st">'.'</span></span>
<span>      <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu"><a href="../reference/replace_empty_values.html">replace_empty_values</a></span><span class="op">(</span></span>
<span>        attributes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Year'</span>, <span class="st">'WEEK'</span>, <span class="st">'Week Ending Date'</span>, <span class="st">'REGION'</span>, <span class="st">'State'</span>, <span class="st">'City'</span><span class="op">)</span>,</span>
<span>        empty_values <span class="op">=</span> <span class="cn">NULL</span></span>
<span>      <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu"><a href="../reference/add_custom_column.html">add_custom_column</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">'city_state'</span>,</span>
<span>                        definition <span class="op">=</span> <span class="va">definition_fun</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu"><a href="../reference/replace_attribute_values.html">replace_attribute_values</a></span><span class="op">(</span></span>
<span>        attributes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'City'</span>, <span class="st">'city_state'</span><span class="op">)</span>,</span>
<span>        old <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Wilimington'</span>, <span class="st">'Wilimington DE'</span><span class="op">)</span>,</span>
<span>        new <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Wilmington'</span>, <span class="st">'Wilmington DE'</span><span class="op">)</span></span>
<span>      <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu"><a href="../reference/join_lookup_table.html">join_lookup_table</a></span><span class="op">(</span>fk_attributes <span class="op">=</span> <span class="st">'city_state'</span>,</span>
<span>                        lookup <span class="op">=</span> <span class="va">lookup_ft</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu"><a href="../reference/select_attributes.html">select_attributes</a></span><span class="op">(</span></span>
<span>        attributes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>          <span class="st">'Year'</span>,</span>
<span>          <span class="st">'WEEK'</span>,</span>
<span>          <span class="st">'Week Ending Date'</span>,</span>
<span>          <span class="st">'REGION'</span>,</span>
<span>          <span class="st">'State'</span>,</span>
<span>          <span class="st">'City'</span>,</span>
<span>          <span class="st">'city_state'</span>,</span>
<span>          <span class="st">'status'</span>,</span>
<span>          <span class="st">'pop'</span>,</span>
<span>          <span class="st">'lat'</span>,</span>
<span>          <span class="st">'long'</span></span>
<span>        <span class="op">)</span></span>
<span>      <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu"><a href="../reference/separate_measures.html">separate_measures</a></span><span class="op">(</span></span>
<span>        measures <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>          <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Pneumonia and Influenza Deaths'</span>, <span class="st">'All Deaths'</span><span class="op">)</span>,</span>
<span>          <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>            <span class="st">'&lt;1 year (all cause deaths)'</span>,</span>
<span>            <span class="st">'1-24 years (all cause deaths)'</span>,</span>
<span>            <span class="st">'25-44 years'</span>,</span>
<span>            <span class="st">'45-64 years (all cause deaths)'</span>,</span>
<span>            <span class="st">'65+ years (all cause deaths)'</span></span>
<span>          <span class="op">)</span></span>
<span>        <span class="op">)</span>,</span>
<span>        names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'mrs_cause'</span>, <span class="st">'mrs_age'</span><span class="op">)</span>,</span>
<span>        na_rm <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>      <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu">magrittr</span><span class="fu">::</span><span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html" class="external-link">extract2</a></span><span class="op">(</span><span class="st">'mrs_age'</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu"><a href="../reference/transform_to_values.html">transform_to_values</a></span><span class="op">(</span></span>
<span>        attribute <span class="op">=</span> <span class="st">'age'</span>,</span>
<span>        measure <span class="op">=</span> <span class="st">'all_deaths'</span>,</span>
<span>        id_reverse <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>        na_rm <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>      <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu"><a href="../reference/snake_case.html">snake_case</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu"><a href="../reference/replace_string.html">replace_string</a></span><span class="op">(</span>attributes <span class="op">=</span> <span class="st">'age'</span>,</span>
<span>                     string <span class="op">=</span> <span class="st">' (all cause deaths)'</span>,</span>
<span>                     replacement <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu"><a href="../reference/as_star_database.html">as_star_database</a></span><span class="op">(</span>schema <span class="op">=</span> <span class="va">star_sch</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="va">ft</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span><span class="va">star_sch</span> <span class="op">&lt;-</span> <span class="va">mrs_db_age_refresh</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/get_star_schema.html">get_star_schema</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">mrs_db_age_transf</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">transform_instance_table_2</span><span class="op">(</span></span>
<span>    instance_df <span class="op">=</span> <span class="va">instance_df</span>,</span>
<span>    lookup_ft <span class="op">=</span> <span class="va">lookup_list</span><span class="op">[[</span><span class="st">'us_cities'</span><span class="op">]</span><span class="op">]</span>,</span>
<span>    definition_fun <span class="op">=</span> <span class="va">city_state</span>,</span>
<span>    star_sch <span class="op">=</span> <span class="va">star_sch</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>The result of these functions, in each case, is a
<code>star_database</code> containing the new transformations.</p>
</div>
<div class="section level3">
<h3 id="refresh-structures-1">Refresh structures<a class="anchor" aria-label="anchor" href="#refresh-structures-1"></a>
</h3>
<p>Now we have to create the refresh structure for each star database,
considering the original constellation (we have made a copy before
updating it in <code>mrs_db_seg</code>). To create the refresh
structures, we now indicate that the operations are considered from the
star database of the <code>sdb_operations</code> parameter.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mrs_db_cause_transf_refresh</span> <span class="op">&lt;-</span> <span class="va">mrs_ft_new</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/update_according_to.html">update_according_to</a></span><span class="op">(</span><span class="va">mrs_db_seg</span>, star <span class="op">=</span> <span class="st">"mrs_cause"</span>, sdb_operations <span class="op">=</span> <span class="va">mrs_db_cause_transf</span><span class="op">)</span></span>
<span></span>
<span><span class="va">mrs_db_age_transf_refresh</span> <span class="op">&lt;-</span> <span class="va">mrs_ft_new</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/update_according_to.html">update_according_to</a></span><span class="op">(</span><span class="va">mrs_db_seg</span>, star <span class="op">=</span> <span class="st">"mrs_age"</span>, sdb_operations <span class="op">=</span> <span class="va">mrs_db_age_transf</span><span class="op">)</span></span></code></pre></div>
<p>That is, with the <code>sdb_operations</code> parameter, it takes the
data to be refreshed from the constellation, but the modification
operations are taken from this star database (where we have defined the
new operations that have been considered necessary).</p>
</div>
<div class="section level3">
<h3 id="incremental-refresh-operation-1">Incremental refresh operation<a class="anchor" aria-label="anchor" href="#incremental-refresh-operation-1"></a>
</h3>
<p>To show the result of the incremental refresh operations, we are
going to repeat the process carried out previously: We show the name and
number of instances of the tables before and after the transformation,
as well as the names of the first cities of the <em>where</em>
dimension.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">l_db</span> <span class="op">&lt;-</span> <span class="va">mrs_db_seg</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/as_tibble_list.html">as_tibble_list</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">names</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">l_db</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">l_db</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"name: %s, %d rows\n"</span>, <span class="va">names</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">l_db</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt; name: when, 1966 rows</span></span>
<span><span class="co">#&gt; name: where, 120 rows</span></span>
<span><span class="co">#&gt; name: who, 5 rows</span></span>
<span><span class="co">#&gt; name: mrs_cause, 3342 rows</span></span>
<span><span class="co">#&gt; name: mrs_age, 16565 rows</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="va">l_db</span><span class="op">[[</span><span class="st">'where'</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">city</span><span class="op">)</span>, <span class="fl">15</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1] "Akron"       "Albany"      "Albuquerque" "Allentown"   "Atlanta"    </span></span>
<span><span class="co">#&gt;  [6] "Austin"      "Baton Rouge" "Berkeley"    "Birmingham"  "Boise"      </span></span>
<span><span class="co">#&gt; [11] "Bridgeport"  "Buffalo"     "Cambridge"   "Camden"      "Canton"</span></span></code></pre></div>
<p>To perform the incremental refresh, as the refresh structure has new
transformation operations, we can indicate that these become the
transformation operations of the constellation. Thus, in future updates,
they will be taken into account automatically. This is indicated by the
boolean parameter <code>replace_transformations</code>.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mrs_db_seg</span> <span class="op">&lt;-</span> <span class="va">mrs_db_seg</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/incremental_refresh.html">incremental_refresh</a></span><span class="op">(</span><span class="va">mrs_db_age_transf_refresh</span>, replace_transformations <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/incremental_refresh.html">incremental_refresh</a></span><span class="op">(</span></span>
<span>    <span class="va">mrs_db_cause_transf_refresh</span>,</span>
<span>    existing_instances <span class="op">=</span> <span class="st">"group"</span>,</span>
<span>    replace_transformations <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>Finally, we consult the same data as before again.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">l_db</span> <span class="op">&lt;-</span> <span class="va">mrs_db_seg</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/as_tibble_list.html">as_tibble_list</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">names</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">l_db</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">l_db</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"name: %s, %d rows\n"</span>, <span class="va">names</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">l_db</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt; name: when, 2076 rows</span></span>
<span><span class="co">#&gt; name: where, 122 rows</span></span>
<span><span class="co">#&gt; name: who, 5 rows</span></span>
<span><span class="co">#&gt; name: mrs_cause, 3677 rows</span></span>
<span><span class="co">#&gt; name: mrs_age, 18228 rows</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="va">l_db</span><span class="op">[[</span><span class="st">'where'</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">city</span><span class="op">)</span>, <span class="fl">15</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1] "Akron"       "Albany"      "Albuquerque" "Allentown"   "Atlanta"    </span></span>
<span><span class="co">#&gt;  [6] "Austin"      "Baltimore"   "Baton Rouge" "Berkeley"    "Birmingham" </span></span>
<span><span class="co">#&gt; [11] "Boise"       "Boston"      "Bridgeport"  "Buffalo"     "Cambridge"</span></span></code></pre></div>
<p>It can be seen that we have obtained the same results as before.</p>
</div>
</div>
<div class="section level2">
<h2 id="conclusions">Conclusions<a class="anchor" aria-label="anchor" href="#conclusions"></a>
</h2>
<p>This document shows the functions supporting incremental refreshing
of star databases offered by the <code>rolap</code> package.</p>
<p>Starting from a flat table, the transformation operations through
which a star database has been defined are automatically applied. These
operations can be obtained and enriched to adapt to new situations that
arise. Once the data has been conveniently updated, it can be integrated
with the original star database indicating the operation that is
considered most appropriate to integrate the data previously existing in
the fact table.</p>
<p>This incremental refresh mechanism, although not trivial, facilitates
this generally difficult process. It lays the foundations to continue
simplifying it and offering new functionalities.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Jose Samos.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
